
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom SQL session start/stop scripts &#8212; GeoServer 2.22.4 User Manual</title>
    <link rel="stylesheet" href="../../_static/blueprint/screen.css" type="text/css" media="screen, projection" />
    <link rel="stylesheet" href="../../_static/blueprint/print.css" type="text/css" media="print" /> 
    <!--[if IE]>
    <link rel="stylesheet" href="../../_static/blueprint/ie.css" type="text/css" media="screen, projection" />
    <![endif]-->
    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/geoserver.ico"/>
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Cascaded service data" href="../cascaded/index.html" />
    <link rel="prev" title="Controlling feature ID generation in spatial databases" href="primarykey.html" /> 
  </head><body class="data/database/sqlsession">
<div id="header" class="selfclear">
    <div class="wrap selfclear">
        <div id="logo"><a href="http://geoserver.org">GeoServer</a></div>
        <ul id="top-nav">
            <li class="first"><a href="http://geoserver.org/about/">About</a></li>
            <li><a href="http://geoserver.org/blog">Blog</a></li>
            <li><a href="http://geoserver.org/download/">Download</a></li>
            <li><a href="https://docs.geoserver.org/">Documentation</a></li>
        </ul>

        <form id="quick-search" action="../../search.html" method="get">
            <fieldset>
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
                <input id="quick-search-query" type="text" name="q" accessKey="q" name="searchQuery.queryString" size="25" size="20" tabindex="3" placeholder="Search User Manual&hellip;" />
                <input id="quick-search-submit" type="image" value="Search" src="../../_static/chrome/search_icon_green.png" />
            </fieldset>
        </form>
    </div><!-- /.wrap -->
</div><!-- /#header -->
    <div id="main">
      <div class="wrap selfclear">
        <div id="content-left" class="content-border"></div>
        <div id="content">
        
<ul id="breadcrumbs">
  
    <li><a href="../../index.html">GeoServer 2.22.4 User Manual</a> &raquo;</li>
        <li><a href="../index.html" accesskey="U">Data management</a> &raquo;</li>
        <li><a href="index.html" accesskey="U">Databases</a> &raquo;</li>
    <li>Custom SQL session start/stop scripts</li>
</ul>
        
<ul id="relatedlinks" class="selfclear">
  <li class="first"><a href="../cascaded/index.html" title="Cascaded service data" accesskey="N">Next</a></li>
  <li>
    <a href="primarykey.html" title="Controlling feature ID generation in spatial databases" accesskey="P">Previous</a>|
  </li>
</ul>
          
  <div class="section" id="custom-sql-session-start-stop-scripts">
<span id="data-sqlsession"></span><h1>Custom SQL session start/stop scripts<a class="headerlink" href="#custom-sql-session-start-stop-scripts" title="Permalink to this headline">¶</a></h1>
<p>Starting with version 2.1.4 GeoServer support custom SQL scripts that can be run every time GeoServer
grabs a connection from the connection pool, and every time the session is returned to the pool.</p>
<p>These scripts can be parametrized with the expansion of environment variables, which can be in turn
set into the OGC request parameters with the same mechanism as <a class="reference internal" href="../../styling/sld/extensions/substitution.html#sld-variable-substitution"><span class="std std-ref">Variable substitution in SLD</span></a>.</p>
<p>In addition to the parameters provided via the request the <code class="docutils literal notranslate"><span class="pre">GSUSER</span></code> variable is guaranteed to
contain the current GeoServer user, or be null if no authentication is available. This is useful
if the SQL sessions scripts are used to provide tight control over database access</p>
<p>The SQL script can expand environment variables using the <code class="docutils literal notranslate"><span class="pre">${variableName,</span> <span class="pre">defaultValue}</span></code> syntax,
for example the following alters the current database user to be the same as the GeoServer current user,
or <code class="docutils literal notranslate"><span class="pre">geoserver</span></code> in case no user was authenticated</p>
<blockquote>
<div><p>SET SESSION AUTHORIZATION ${GSUSER,geoserver}</p>
</div></blockquote>
<div class="section" id="using-sql-session-scripts-to-control-authorizations-at-the-database-level">
<h2>Using SQL session scripts to control authorizations at the database level<a class="headerlink" href="#using-sql-session-scripts-to-control-authorizations-at-the-database-level" title="Permalink to this headline">¶</a></h2>
<p>GeoServer connects to a database via a connection pool, using the same rights as the user that
is specified in the connection pool setup.
In a setup that provides a variety of services and tables the connection pool user must have
a rather large set of rights, such as table selection (WMS), table insert/update/delete (WFS-T) and
even table creation (data upload via RESTConfig, WPS Import process and eventual new processes leveraging
direct database connections).</p>
<p>What a user can do can be controlled by means of the GeoServer security subsystem, but in high security
setups this might not be considered enough, and a database level access control be preferred instead.
In these setups normally the connection pool user has limited access, such as simple read only access,
while specific users are allowed to perform more operations.</p>
<p>When setting up such a solution remember the following guidelines:</p>
<ul class="simple">
<li><p>The connection pool user must be able to access all table metadata regardless of whether it is able
to actually perform a select on the tables (dictionary tables/describe functionality must be always accessible)</p></li>
<li><p>The connection pool must see each and every column of tables and views, in other words, the
structure of the tables must not change as the current user changes</p></li>
<li><p>the database users and the GeoServer user must be kept in synch with some external tools, GeoServer
provides no out of the box facilities</p></li>
<li><p>during the GeoServer startup the code will access the database to perform some sanity checks,
in that moment there is no user authenticated in GeoServer so the code will run under whatever
user was specified as the “default value” for the <code class="docutils literal notranslate"><span class="pre">GSUSER</span></code> variable.</p></li>
<li><p>The user that administers GeoServer (normally <code class="docutils literal notranslate"><span class="pre">admin</span></code>, but it can be renamed, and other users
given the administration roles too) must also be a database user, all administrative access on the
GeoServer GUI will have that specific user controlling the session</p></li>
</ul>
<p>Typical use cases:</p>
<ul class="simple">
<li><p>Give insert/update/delete rights only to users that must use WFS-T</p></li>
<li><p>Only allow the administrator to create new tables</p></li>
<li><p>Limit what rows of a table a user can see by using dynamic SQL views taking into account the
current user to decide what rows to return</p></li>
</ul>
<p>To make a point in case, if we want the PostgreSQL session to run with the current GeoServer user
credentials the following scripts will be used:</p>
<div class="figure align-center" id="id1">
<img alt="../../_images/postgresqlSession.png" src="../../_images/postgresqlSession.png" />
<p class="caption"><span class="caption-text"><em>Setting up session authorization for PostgreSQL</em></span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>The first command makes the database session use either the current GeoServer user, or the <code class="docutils literal notranslate"><span class="pre">geoserver</span></code>
user if no authentication was available (anonymous user, or startup situation).
The second command resets the session to the rights of the connection pool user.</p>
</div>
</div>


        <div class="selfclear pagination-nav">
            <div class="leftwise"><strong>Previous</strong>: <a href="primarykey.html" title="previous chapter">Controlling feature ID generation in spatial databases</a></div>
            <div class="rightwise"><strong>Next</strong>: <a href="../cascaded/index.html" title="next chapter">Cascaded service data</a></div>
        </div>
        </div><!-- /#content> -->
        <div id="content-right" class="content-border"></div>
        
  <div id="sidebar" class="contrast">
      <div id="toc" class="section">
        <h3 class="pngfix"><a href="../../index.html">Table Of Contents</a></h3>
        <ul>
<li><a class="reference internal" href="#">Custom SQL session start/stop scripts</a><ul>
<li><a class="reference internal" href="#using-sql-session-scripts-to-control-authorizations-at-the-database-level">Using SQL session scripts to control authorizations at the database level</a></li>
</ul>
</li>
</ul>

        <div class="section-footer"></div>
      </div>
        <div class="section">
          <h3>Continue Reading</h3>
          <ul>
            <li>Previous: <a href="primarykey.html" title="previous chapter">Controlling feature ID generation in spatial databases</a></li>
            <li>Next: <a href="../cascaded/index.html" title="next chapter">Cascaded service data</a></li>
          </ul>
        </div>
        <div class="section">
        <h3>This Page</h3>
        <ul class="this-page-menu">
        
        <li><a href="https://github.com/geoserver/geoserver/tree/main/doc/en/user/source/data/database/sqlsession.rst">Edit</a></li>
        </ul>
        </div>
      <div class="section">
        <h3>Known GeoServer issues</h3>
        <ul class="this-page-menu">
          <li><a href="https://osgeo-org.atlassian.net/projects/GEOS/summary">Jira issue tracker</a></li>
        </ul>
      </div>
  </div><!-- /#sidebar -->
    </div><!-- /.wrap> -->
  </div><!-- /#main -->
<div id="footer">
    <div class="wrap">
        &copy; Copyright 2023, Open Source Geospatial Foundation. License <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution</a>.
        Last updated on Jun 18, 2023.
        Created using <a href="http://www.sphinx-doc.org/">Sphinx</a>.
    </div><!-- /.wrap> -->
</div><!-- /#footer -->
  </body>
</html>